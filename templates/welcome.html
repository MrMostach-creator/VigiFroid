{# templates/welcome.html #}
{% extends "base.html" %}
{% block title %}VigiFroid Â· {{ _('Welcome') }}{% endblock %}
{% set page_class = "page welcome-page" %}

{% block content %}

<!-- ğŸ¥ Welcome Video Overlay (First time only) -->
<div id="vf-welcome-video-overlay" class="vf-welcome-overlay" aria-hidden="true">
  <video
    id="vf-welcome-video"
    class="vf-welcome-video"
    autoplay
    muted
    loop
    playsinline
    preload="metadata"
    poster="{{ url_for('static', filename='images/welcome_poster.png') }}"
  >
    <source src="{{ url_for('static', filename='videos/welcome.mp4') }}" type="video/mp4">
  </video>

  <div class="vf-welcome-shade"></div>

  <div class="vf-welcome-actions text-center">
    <div class="mb-2">
      <div class="h4 mb-1">
        {{ _('Welcome to') }} <strong>VigiFroid</strong>
      </div>
      <div class="small opacity-75">
        {{ _('Internal application for monitoring and tracing refrigerated lots.') }}
      </div>
    </div>

    <button type="button" id="vf-welcome-video-close" class="btn btn-primary btn-lg">
      {{ _('Continue') }}
    </button>
  </div>
</div>

<div class="d-flex justify-content-center align-items-center" style="min-height: 100vh; padding: 20px;">
  <div class="card w-100 shadow-sm" style="max-width: 480px;">
    <div class="card-body text-center">

      <!-- ğŸ‘‹ Ù„ÙˆØºÙˆ + Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ø³ÙŠØ·Ø© -->
      <div class="mb-3">
        <div class="logo-bounce mb-3">
          <img class="img-fluid rounded-circle"
               src="{{ url_for('static', filename='images/welcome_poster.png') }}"
               alt="Welcome Logo"
               style="max-height: 100px;">
        </div>
        <h1 class="h4 mb-2">
          {{ _('Welcome to') }} <strong>VigiFroid</strong>
        </h1>
        <p class="text-muted mb-0">
          {{ _('Internal application for monitoring and tracing refrigerated lots.') }}
        </p>
      </div>

      <hr>

      <!-- ğŸ‘£ Step 1: Ù†Øµ ØªØ±Ø­ÙŠØ¨ÙŠ + Ø²Ø± Ù…ØªØ§Ø¨Ø¹Ø© -->
      <div id="step-1" class="mb-3">
        <p class="mb-4">
          {{ _('We will first save your professional email address to secure your access (password reset, notifications, etc.).') }}
        </p>

        <button id="btn-go-step2" class="btn btn-primary btn-lg">
          {{ _('Continue') }}
        </button>
      </div>

      <!-- âœ‰ï¸ Step 2: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ + Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø´Ø±ÙˆØ· -->
      <div id="step-2" class="mt-3" style="display:none;">
        <form method="post" action="{{ url_for('auth.onboarding_email') }}">
          {# ğŸ›¡ï¸ CSRF token Ø¨Ø­Ø§Ù„ login Ùˆ forgot/reset #}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <div class="mb-3 text-start">
            <label for="email" class="form-label">
              {{ _('E-mail address') }}
            </label>
            <input type="email"
                   class="form-control"
                   id="email"
                   name="email"
                   placeholder="prenom.nom@entreprise.com"
                   required>
            <div class="form-text">
              {{ _('This address will be used to secure your account (password reset, notifications...).') }}
            </div>
          </div>

          <div class="form-check text-start mb-3">
            <input class="form-check-input" type="checkbox" value="1" id="accept-rules">
            <label class="form-check-label" for="accept-rules">
              {{ _('I agree to use VigiFroid only within the internal professional context.') }}
            </label>
          </div>

          <button type="submit" class="btn btn-success btn-lg w-100" id="btn-submit-email">
            {{ _('Validate and continue') }}
          </button>
        </form>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  /* ğŸ¬ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø®ÙÙŠÙØ© Ù„Ù„ÙˆØºÙˆ Ø¨Ø­Ø§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© */
  .logo-bounce {
    animation: logoBounce 1.4s ease-in-out infinite alternate;
  }

  @keyframes logoBounce {
    from {
      transform: translateY(0);
      opacity: 0.9;
    }
    to {
      transform: translateY(-8px);
      opacity: 1;
    }
  }

  /* ğŸ¥ Fullscreen welcome video overlay */
  .vf-welcome-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
    background: #000;
  }

  .vf-welcome-overlay.is-open {
    display: block;
  }

  .vf-welcome-video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .vf-welcome-shade {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.15);
  }

  .vf-welcome-actions {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    width: min(92vw, 520px);
    padding: 16px;
  }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function () {
    // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø¨Ù‚ Ø¯Ø§Ø± onboarding ÙÙ‡Ø§Ø¯ Ø§Ù„Ø¬Ù‡Ø§Ø² â†’ Ø±Ø¬Ù‘Ø¹Ùˆ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù‘ÙˆØ¬ÙŠÙ†
    try {
      if (localStorage.getItem('vf_onboarding_done') === '1') {
        window.location.href = "{{ url_for('auth.login') }}";
        return;
      }
    } catch (e) {
      // Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø§ ÙƒÙŠØ¯Ø¹Ù…Ø´ localStorage â†’ Ù†Ø®Ù„ÙŠÙ‡ ÙŠÙƒÙ…Ù„ Ø¹Ø§Ø¯ÙŠ
    }

    // ğŸ¥ First-time welcome video (independent from onboarding)
    try {
      var VIDEO_KEY = 'vf_welcome_video_seen_v1';
      var overlay = document.getElementById('vf-welcome-video-overlay');
      var video = document.getElementById('vf-welcome-video');
      var btnClose = document.getElementById('vf-welcome-video-close');

      function closeWelcomeVideo() {
        try {
          localStorage.setItem(VIDEO_KEY, '1');
        } catch (err) {}
        if (overlay) overlay.classList.remove('is-open');
        document.body.style.overflow = '';
        try { if (video) { video.pause(); video.currentTime = 0; } } catch (e) {}
      }

      if (overlay && video && btnClose) {
        if (localStorage.getItem(VIDEO_KEY) !== '1') {
          overlay.classList.add('is-open');
          document.body.style.overflow = 'hidden';
          video.play().catch(function () { /* autoplay may be blocked on some devices */ });
        }

        btnClose.addEventListener('click', function () {
          closeWelcomeVideo();
        });

        // âŒ Ø­Ø°ÙÙ†Ø§ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù„Ù‰ ended Ø¨Ø§Ø´ Ù…Ø§ ÙŠØªØ­ÙŠØ¯Ø´ Ø¨ÙˆØ­Ø¯Ùˆ
      }
    } catch (e) {
      // Ø¥Ø°Ø§ ÙˆÙ‚Ø¹ Ù…Ø´ÙƒÙ„ ÙÙ€ localStorage/DOMØŒ Ù…Ø§ Ù†Ø­Ø¨Ø³ÙˆØ´ onboarding
    }

    var step1 = document.getElementById('step-1');
    var step2 = document.getElementById('step-2');
    var btnGoStep2 = document.getElementById('btn-go-step2');
    var btnSubmitEmail = document.getElementById('btn-submit-email');

    if (btnGoStep2 && step1 && step2) {
      btnGoStep2.addEventListener('click', function () {
        step1.style.display = 'none';
        step2.style.display = 'block';
        var emailInput = document.getElementById('email');
        if (emailInput) {
          emailInput.focus();
        }
      });
    }

    // Ù‚Ø¨Ù„ Ù…Ø§ Ù†Ø±Ø³Ù„ Ø§Ù„ÙÙˆØ±Ù…ØŒ Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆÙ†Ø®Ø²Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙ€ localStorage
    if (btnSubmitEmail) {
      btnSubmitEmail.addEventListener('click', function (e) {
        var checkbox = document.getElementById('accept-rules');
        if (checkbox && !checkbox.checked) {
          e.preventDefault();
          alert("{{ _('Please confirm your agreement before continuing.') }}");
          return false;
        }

        try {
          // Ù†Ø®Ù„ÙŠ Ø¹Ù„Ø§Ù…Ø© Ø¨Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø± onboarding ÙÙ‡Ø§Ø¯ Ø§Ù„Ø¬Ù‡Ø§Ø²
          var emailInput = document.getElementById('email');
          if (emailInput) {
            // Ù†Ø®Ø²Ù‘Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ (auto-fill ÙÙ€ forgot password)
            localStorage.setItem('vf_email', emailInput.value.trim());
          }
          localStorage.setItem('vf_onboarding_done', '1');
        } catch (err) {
          // Ø¥Ø°Ø§ ÙˆÙ‚Ø¹Ø§Øª Ø´ÙŠ Ù…Ø´ÙƒÙ„ ÙÙ€ localStorageØŒ Ù†Ø®Ù„ÙŠÙ‡ ØºÙŠØ± ÙŠØ±Ø³ÙÙ„ Ø§Ù„ÙÙˆØ±Ù…
        }
        return true;
      });
    }
  })();
</script>
{% endblock %}
