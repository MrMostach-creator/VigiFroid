<!-- templates/export_settings.html -->

{% extends "base.html" %}
{% block title %}VigiFroid Â· {{ _('Export settings') }}{% endblock %}
{% set page_class = "page settings-page" %}

{% block content %}
<div class="d-flex justify-content-center align-items-start"
  style="min-height: calc(100vh - var(--header-h)); padding-top: var(--spacing-3xl);">

  <div class="card w-100 shadow-sm" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">

    <div class="card-body">

      <h1 class="h5 mb-2 text-center">{{ _('Monthly export settings') }}</h1>
      <p class="text-muted small mb-4 text-center">
        {{ _('Configure automatic monthly export of lots report to the quality manager.') }}
      </p>

      <form method="post" novalidate>
        {{ form.hidden_tag() }}

        <!-- ON/OFF -->
        <div class="form-check form-switch mb-3">
          {{ form.export_enabled(class="form-check-input", id="export_enabled") }}
          <label class="form-check-label" for="export_enabled">
            {{ _('Enable monthly export to quality manager') }}
          </label>
          <div class="form-text">
            {{ _('When enabled, the report will be sent automatically every month.') }}
          </div>
        </div>

        <hr class="my-3">

        <!-- Email -->
        <div class="mb-3" id="wrap_quality_emails">
          <label for="quality_emails" class="form-label">{{ _('Quality manager emails') }}</label>
          {{ form.quality_emails(class="form-control",
          id="quality_emails",
          rows="3",
          placeholder="manager1@example.com\nmanager2@example.com") }}
          <div class="form-text">
            {{ _('Enter one or more emails (separated by new line or comma).') }}
          </div>

          {% if form.quality_emails.errors %}
          {% for error in form.quality_emails.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
          {% endfor %}
          {% endif %}
        </div>

        <!-- Day -->
        <div class="mb-3" id="wrap_export_day">
          <label for="export_day" class="form-label">{{ _('Day of month for export') }}</label>
          {{ form.export_day(class="form-control",
          id="export_day",
          min="1",
          max="28",
          step="1",
          inputmode="numeric") }}
          <div class="form-text">
            {{ _('The report will be sent once a month on this day (1â€“28). Recommended: 1.') }}
          </div>

          {% if form.export_day.errors %}
          {% for error in form.export_day.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
          {% endfor %}
          {% endif %}
        </div>

        <!-- Format -->
        <div class="mb-3" id="wrap_export_format">
          <label for="export_format" class="form-label">{{ _('Report format') }}</label>
          {{ form.export_format(class="form-select", id="export_format") }}
          <div class="form-text">
            {{ _('Choose whether the report is sent as PDF or CSV.') }}
          </div>

          {% if form.export_format.errors %}
          {% for error in form.export_format.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
          {% endfor %}
          {% endif %}
        </div>

        <!-- Language -->
        <div class="mb-3" id="wrap_report_language">
          <label for="report_language" class="form-label">{{ _('Report language') }}</label>
          {{ form.report_language(class="form-select", id="report_language") }}
          <div class="form-text">
            {{ _('Choose the language of the exported report (PDF/CSV).') }}
          </div>

          {% if form.report_language.errors %}
          {% for error in form.report_language.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
          {% endfor %}
          {% endif %}
        </div>

        <button type="submit" class="btn btn-primary w-100">
          {{ _('ðŸ’¾ Save') }}
        </button>
      </form>

      {% if settings %}
      <hr class="my-4">
      <div class="small text-muted">
        <div class="d-flex justify-content-between">
          <span>{{ _('Auto-export') }}</span>
          {% if settings.auto_export_enabled %}
          <span class="text-success fw-semibold">{{ _('Enabled') }}</span>
          {% else %}
          <span class="text-danger fw-semibold">{{ _('Disabled') }}</span>
          {% endif %}
        </div>

        <div class="d-flex justify-content-between mt-2">
          <span>{{ _('Recipients') }}</span>
          <span class="fw-semibold text-end" style="white-space: pre-line;">{{ settings.get_recipients()|join(', ') or
            '-' }}</span>
        </div>

        <div class="d-flex justify-content-between mt-2">
          <span>{{ _('Day of month') }}</span>
          <span class="fw-semibold">{{ settings.export_day or '-' }}</span>
        </div>

        <div class="d-flex justify-content-between mt-2">
          <span>{{ _('Format') }}</span>
          <span class="fw-semibold">{{ (settings.export_format or '-')|upper }}</span>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function () {
    const toggle = document.getElementById('export_enabled');

    const email = document.getElementById('quality_emails');
    const day = document.getElementById('export_day');
    const fmt = document.getElementById('export_format');
    const lang = document.getElementById('report_language');

    const wrapEmail = document.getElementById('wrap_quality_emails');
    const wrapDay = document.getElementById('wrap_export_day');
    const wrapFmt = document.getElementById('wrap_export_format');
    const wrapLang = document.getElementById('wrap_report_language');

    function setDisabled(el, wrap, disabled) {
      if (!el) return;
      el.disabled = disabled;
      if (wrap) wrap.classList.toggle('opacity-75', disabled);
    }

    function syncDisabled() {
      const enabled = !!(toggle && toggle.checked);
      const disabled = !enabled;

      setDisabled(email, wrapEmail, disabled);
      setDisabled(day, wrapDay, disabled);
      setDisabled(fmt, wrapFmt, disabled);
      setDisabled(lang, wrapLang, disabled);
    }

    if (toggle) {
      toggle.addEventListener('change', syncDisabled);
      syncDisabled();
    }
  })();
</script>
{% endblock %}